<!DOCTYPE html>
  <html lang="es">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validador de Facturas</title>
    <style>
      :root {
        --primary: #9b87f5;
        --primary-dark: #7a68c3;
        --secondary: #33C3F0;
        --dark: #1A1F2C;
        --gray: #8E9196;
        --light: #f8f9fa;
        --border: #e2e8f0;
        --success: #10b981;
        --danger: #ef4444;
      }
      
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f5f5f9;
        color: var(--dark);
        line-height: 1.6;
        padding: 0;
        margin: 0;
      }
      
      .container {
        max-width: 1500px;
        margin: 0 auto;
        padding: 20px;
      }


      .back-link {
        display: inline-flex;
        align-items: center;
        color: #9b87f5;
        text-decoration: none;
        transition: color 0.2s, background-color 0.2s;
        background-color: #f8f9fa;
        padding: 8px 12px;
        border-radius: 5px;
        font-weight: 500;
      }

      .back-link:hover {
        background-color: #9b87f5;
        color: white;
      }

      .back-link svg {
        margin-right: 6px;
      }

      .back-link::before {
        content: "‚Üê";
        margin-right: 0.5rem;
        color:#9b87f5;
      }
      .back-link:hover:before {
        color:#ffffff;
      }
      header {
        background-color: white;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        padding: 20px;
        margin-bottom: 30px;
      }
      
      h1 {
        color: var(--dark);
        font-size: 28px;
        font-weight: 600;
        margin-bottom: 5px;
      }
      
      .subtitle {
        color: var(--gray);
        font-size: 16px;
        margin-bottom: 10px;
      }
      
      .card {
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        padding: 24px;
        margin-bottom: 24px;
      }
      
      .card-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 20px;
        color: var(--dark);
        display: flex;
        align-items: center;
      }

      .card-title svg {
        margin-right: 10px;
      }
      
      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 20px;
      }
      
      .form-group {
        margin-bottom: 5px;
      }
      
      label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        font-size: 14px;
        color: var(--dark);
      }
      
      input, select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--border);
        border-radius: 6px;
        font-size: 14px;
        transition: border-color 0.3s;
      }
      
      input:focus, select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(155, 135, 245, 0.1);
      }
      
      input[type="date"] {
        appearance: none;
      }
      
      .button {
        background-color: var(--primary);
        color: white;
        border: none;
        border-radius: 6px;
        padding: 10px 20px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.3s, transform 0.1s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      
      .button:hover {
        background-color: var(--primary-dark);
      }
      
      .button:active {
        transform: translateY(1px);
      }
      
      .button svg {
        margin-right: 8px;
      }
      
      .button-secondary {
        background-color: white;
        color: var(--dark);
        border: 1px solid var(--border);
      }
      
      .button-secondary:hover {
        background-color: var(--light);
      }
      
      .button-secondary.activo {
        background-color: #e0e0e0;
        border-color: #999;
      }

      .button-small {
        padding: 6px 12px;
        font-size: 13px;
      }
      
      .button-success {
        background-color: var(--success);
      }
      
      .button-success:hover {
        background-color: #0da271;
      }
      
      .button-group {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }

      .button-upload {
        background-color: var(--success); 
        color: white;
      }

      .button-upload:hover {
        background-color: #0da271;
      }

      .button:disabled {
          background-color: #e2e8f0; 
          color: #a0aec0; 
          cursor: default; 
          opacity: 0.6; 
      }


      .table-cell-center {
          text-align: center;
      }

      .table-cell-center button {
          margin: 0 auto; 
      }

      
      .actions-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 20px;
      }
      
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        font-size: 14px;
      }
      
      th, td {
        text-align: left;
        padding: 12px 12px;
        border-bottom: 1px solid var(--border);
      }

      th {
        background-color: var(--light);
        font-weight: 600;
        color: var(--dark);
      }
      
      tbody tr:hover {
        background-color: rgba(155, 135, 245, 0.05);
      }
      
      .checkbox-cell {
        width: 40px;
        text-align: center;
      }
      
      .custom-checkbox {
        cursor: pointer;
        width: 18px;
        height: 18px;
      }
      
      .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: var(--gray);
      }

      svg {
      width: 20px;
      height: 20px;
      }

      .button-flex {
        display: flex;
        gap: 10px;
        justify-content: center;
      }


      #toastContainer {
        position: fixed;
        top: 20px;
        right: 20px;
        display: flex;
        flex-direction: column; 
        gap: 10px; 
        z-index: 1000;
      }
      
      .toast {
        background-color: white;
        color: var(--dark);
        padding: 12px 20px;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        display: flex;
        align-items: center;
        animation: slideIn 0.3s ease-out;
        max-width: 200px;
        position: relative;
        overflow: hidden;
        word-wrap: break-word; 
        hyphens: auto; 
        height: auto;
      }
      

      .close-toast {
          background: none;
          border: none;
          color: inherit;
          font-size: 1.2em;
          cursor: pointer;
          margin-left: 10px;
          position: absolute; 
          top: 10px; 
          right: 10px; 
      }

      .toast.success {
        border-left: 4px solid var(--success);
      }
      
      .toast.error {
        border-left: 4px solid var(--danger);
      }
      
      .toast-icon {
        margin-right: 12px;
        flex-shrink: 0;
      }
      
      .toast-content p {
        flex-grow: 1;
        max-width: 160px;
        height: auto;
      }

      .toast-content strong {

        font-size: 14px;
      }
      
      .toast-title {
        font-weight: 600;
        margin-bottom: 2px;
      }
      
      .toast-message {
        font-size: 13px;
        color: var(--gray);
      }

    .toast-progress-container {
        width: 100%;
        background-color: #eee;
        height: 10px;
        border-radius: 5px;
        margin: 8px 0;
        overflow: hidden;
    }

    .toast-progress-bar {
        height: 100%;
        background-color: #4caf50;
        width: 0%;
        transition: width 0.5s ease-in-out;
    }


      .lista-enumerada {
          margin: 0;
          padding-left: 1.5em;
      }

      .lista-enumerada li {
          margin-bottom: 12px; 
          line-height: 1.4;   
      }

      td {
        vertical-align: top;
      }

      #resultados th:nth-child(2),
      #resultados td:nth-child(2) {
        width: 130px;
        max-width: 130px;
        text-align: center;
        white-space: normal;
        overflow: hidden;
        text-overflow: ellipsis;
        word-break: break-word;
      }

      #resultados th:nth-child(3),
      #resultados td:nth-child(3) {
        width: 113px;
        max-width: 113px;
        white-space: normal;
        overflow: hidden;
        text-overflow: ellipsis;
        word-break: break-word;
      }

      #resultados th:nth-child(4),
      #resultados td:nth-child(4) {
        text-align: center;
        width: 108px;
        max-width: 108px;
        white-space: normal;
        overflow: hidden;
        text-overflow: ellipsis;
        word-break: break-word;
      }

      #resultados th:nth-child(5),
      #resultados td:nth-child(5) {
        width: 130px;
        max-width: 130px;
        text-align: center;
        white-space: normal;
        overflow: hidden;
        text-overflow: ellipsis;
        word-break: break-word;
      }
 
      #resultados th:nth-child(6){
        width: 170px;
        max-width: 170px;
        white-space: normal;
        overflow: hidden;
        text-overflow: ellipsis;
        word-break: break-word;
        text-align: center;
      }

      #resultados td:nth-child(6) {
        width: 150px;
        max-width: 150px;
        white-space: normal;
        overflow: hidden;
        text-overflow: ellipsis;
        word-break: break-word;
        text-align: center;
      }

      #resultados th:nth-child(7){
        width: 170px;
        max-width: 170px;
        white-space: normal;
        overflow: hidden;
        text-overflow: ellipsis;
        word-break: break-word;
        text-align: center;
      }

      #resultados td:nth-child(7) {
        width: 200px;
        max-width: 200px;
        white-space: normal;
        overflow: hidden;
        text-overflow: ellipsis;
        word-break: break-word;
        text-align: left;
      }
      
      #resultados th:nth-last-child(2),
      #resultados td:nth-last-child(2){
        text-align: center;
        width: 200px;
        max-width: 200px;
      }

      #resultados th:nth-last-child(3),
      #resultados td:nth-last-child(3){
        text-align: center;
        width: 120px;
        max-width: 120px;
        white-space: normal;
        overflow: hidden;
        text-overflow: ellipsis;
        word-break: break-word;
      }
      #resultados th:nth-last-child(4){
        text-align: center;
        width: 230px;           
        max-width: 230px;
        white-space: normal;      
        word-break: break-word;   
        overflow-wrap: break-word;
      }

      #resultados td:nth-last-child(4){
        text-align: left;
        width: 200px;           
        max-width: 200px;
        white-space: normal;      
        word-break: break-word;   
        overflow-wrap: break-word;
      }

      .accionis {
        text-align: center;
        width: 120px;
        max-width: 120px;
      }

      .cuv-cell {
        max-width: 200px; 
        word-break: break-all;
        overflow-wrap: break-word;
        white-space: normal;
        padding: 8px;
        vertical-align: top;
     }
      

      .verjson-header {
        position: sticky;
        top: 0;
        background-color: white;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 15px;
        border-bottom: 1px solid #ddd;
        z-index: 10;
      }

      .verjson-title {
        font-size: 16px;
        font-weight: bold;
        margin: 0;
      }

      .verjson-toolbar {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .verjson-search {
        width: 230px;
        padding: 6px 10px;
        border-radius: 5px;
        border: 1px solid #ccc;
      }

      .navbtn, .cerrarjson {
        cursor: pointer;
        color: #fff;
        background-color: #9b87f5;
        border: none;
        border-radius: 5px;
        padding: 8px 12px;
        font-size: 14px;
      }

      .navbtn:hover, .cerrarjson:hover {
        background-color: #7f6fc5;
      }

      #matchCounter {
        font-size: 14px;
        color: #333;
        white-space: nowrap;
      }

      pre#jsonContent {
        white-space: pre-wrap;
        background: #f8f8f8;
        padding: 15px;
        margin: 0;
        font-family: monospace;
      }
      .match {
        background-color: #ffeb3b;
        padding: 2px 4px;
        border-radius: 3px;

      }

      .current-match {
        background-color: #ff6600 !important;
        color: white !important;
        border: 2px solid #ff4400;
      }


     .error-row {
        background-color: #ffcdd2; 
      }

      .fila-verde {
        background-color: #c8e6c9;
      }

      

     .expandable {
        display: flex;
        align-items: flex-start;
        gap: 5px;
        max-width: 300px;
      }

    .expand-content {
        overflow: hidden;
        max-height: 7em; 
        transition: max-height 0.5s ease;
        position: relative;
        white-space: normal;
    }

    .expand-content::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 1.2em;

        pointer-events: none;
        display: block;
        opacity: 1;
        transition: opacity 0.3s ease;
        }

    .expand-content.expanded {
        max-height: none;
        }

    .expand-content.expanded::after {
        opacity: 0;
        }

    .toggle-button {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1.2rem;
        padding: 0;
        margin-top: 2px;
        transition: transform 0.3s ease;
        display: inline-flex;
        align-items: center;
        color: #444;
    }

    .toggle-button .arrow {
        display: inline-block;
        transition: transform 0.3s ease;
    }

    .toggle-button.expanded .arrow {
        transform: rotate(90deg);
    }




     .estado-cell {
        color: gray;
        font-weight: bold;
      }
     .estado-verde {
        color: green;
        font-weight: bold;
      }


    .json-object,
    .json-array {
        margin-left: 20px;
    }

    .json-input {
        border: 1px solid #ccc;
        font-family: monospace;
        font-size: 14px;
        width: auto;
        min-width: 40px;
        max-width: 200px;
        padding: 2px;
        background: transparent;
    }

    .json-line {
        white-space: nowrap;
    }

    .collapse-btn {
        background: none;
        border: none;
        color: #007bff;
        cursor: pointer;
        font-family: monospace;
        font-size: 12px;
        margin-right: 5px;
        padding: 0;
        text-decoration: underline;
        user-select: none;
    }

    .checkbox-container {
      text-align: center;
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 14px;
      font-weight: 500;
      color: var(--dark);
      padding-left: 10px;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 45px;
      height: 22px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0;
      right: 0; bottom: 0;
      background-color: #ccc;
      transition: 0.4s;
      border-radius: 34px;
    }

    .slider::before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.4s;
      border-radius: 50%;
    }

    .switch input:checked + .slider {
      background-color: #10b981;
    }

    .switch input:checked + .slider::before {
      transform: translateX(23px);
    }
        


      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      
      @keyframes fadeOut {
        from {
          opacity: 1;
        }
        to {
          opacity: 0;
        }
      }
      
      .fadeOut {
        animation: fadeOut 0.3s forwards;
      }
      
            /* Estilos generales para pantallas peque√±as */
      @media (max-width: 768px) {
        table, thead, tbody, th, td, tr {
            display: block;
        }

        thead {
            display: none;
        }

        tr {
            margin-bottom: 15px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 10px;
        }

        td {
            padding: 8px;
            text-align: left;
            position: relative;
        }

        td::before {
            content: attr(data-label);
            position: absolute;
            left: 10px;
            top: 8px;
            font-weight: bold;
            color: var(--gray);
        }
     }


      /* Estilos para pantallas muy peque√±as (m√≥viles) */
      @media (max-width: 480px) {
          h1 {
              font-size: 20px; 
          }

          .button {
              padding: 8px 12px; 
              font-size: 12px; 
          }

          .card {
              padding: 16px; 
          }

          .empty-state {
              padding: 20px 10px; 
          }
      }

    </style>
 
  <body>
    <script>
        const tokenSQL = sessionStorage.getItem('tokenSQL');
        const token = sessionStorage.getItem('token');

        if (!tokenSQL) {
        sessionStorage.clear();
        window.location.href = 'loginsql.html';
        }

        if (!token) {
        sessionStorage.removeItem('token');
        sessionStorage.removeItem('pestanaActiva');
        window.location.href = 'login.html';
        }

        if (!sessionStorage.getItem('pestanaActiva')) {
        sessionStorage.clear();
        window.location.href = 'loginsql.html';
        }

        sessionStorage.setItem('pestanaActiva', 'true');
    </script>


    <header>
        <div class="container">
            <a href="inicio.html" class="back-link">Volver</a>
            <h1>Validador de Facturas</h1>
            <p class="subtitle">Sistema de validaci√≥n de facturas electr√≥nicas</p>
        </div>
    </header>

    <div class="container">
        <div class="card">
            <h2 class="card-title">Criterios de b√∫squeda</h2>
            <form id="facturasForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="fechaDesde">Fecha Desde</label>
                        <input type="date" id="fechaDesde" name="fechaDesde">
                    </div>
                    <div class="form-group">
                        <label for="fechaHasta">Fecha Hasta</label>
                        <input type="date" id="fechaHasta" name="fechaHasta">
                    </div>
                    <div class="form-group">
                        <label for="idTercero">Tercero</label>
                        <select id="idTercero" name="idTercero">
                            <option value="">Seleccione un tercero</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="noContrato">Contrato</label>
                        <select id="noContrato" name="noContrato">
                            <option value="">Seleccione un contrato</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="nFact">No. Factura</label>
                        <input type="text" id="nFact" name="nFact" placeholder="Ingrese factura">
                    </div>

                    <div class="form-group">
                        <label for="cuentaCobro">N√∫mero de Cuenta de Cobro</label>
                        <input type="text" id="cuentaCobro" name="cuentaCobro" placeholder="Ingrese cuenta de cobro">
                    </div>
                </div>
                <div class="button-group">
                    <button type="submit" class="button" id="botonBuscar">Buscar</button>
                </div>
            </form>
        </div>
        

        <div id="accionesDiv" class="card" style="display:none;">
            <div class="actions-bar">

                <div class="checkbox-container">
                    <label for="incluirXML">Incluir XML</label>
                        <label class="switch">
                        <input type="checkbox" id="incluirXML" checked>
                        <span class="slider"></span>
                    </label>
                </div>



                <div class="button-group">
                    <button id="DescargarPaquetesBtn" onclick="DescargarPaquetes()" class="button button-success" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        Descargar Paquetes
                    </button>
                    <button id="enviarPaquetesBtn" onclick="enviarPaquetes()" class="button button-success" disabled> 
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 2L11 13" />
                        <path d="M22 2L15 22L11 13L2 9L22 2Z" />
                      </svg>Enviar paquetes</button>
                    <button onclick="seleccionarPorEstado('todos')" class="button button-secondary button-small">Seleccionar todo</button>
                    <button onclick="seleccionarPorEstado('enviados')" class="button button-secondary button-small">Seleccionar enviados</button>
                    <button onclick="seleccionarPorEstado('pendientes')" class="button button-secondary button-small">Seleccionar pendientes</button>
                    <button onclick="seleccionarPorEstado('ninguno')" class="button button-secondary button-small">Deseleccionar todo</button>
                                    
                </div>
            </div>
            <div class="table-container">
                <table id="resultados">
                    <thead id="tablaHead"></thead>
                    <tbody id="tablaBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="toastContainer"></div>

    <script>
        const host = window.location.hostname;

        document.addEventListener('DOMContentLoaded', () => {
            const fechaDesdeInput = document.getElementById('fechaDesde');
            const today = new Date().toISOString().split('T')[0];
            fechaDesdeInput.value = today;

            const fechaHastaInput = document.getElementById('fechaHasta');
            fechaHastaInput.value = today;

            cargarTerceros();


            document.addEventListener('change', function (e) {
                if (e.target.classList.contains('filaCheckbox') || e.target.id === 'selectAll') {
                    verificarCheckboxes();
                }
            });
        });

        async function verJSON(idMovDoc) {
            
            const host = window.location.hostname;
            const button = document.querySelector(`button[onclick="verJSON('${idMovDoc}')"]`);

            let originalHTML = '';
            if (button) {
                originalHTML = button.innerHTML;
                button.disabled = true;
                button.innerHTML = 'Ver JSON';
                button.style.opacity = '0.6';
                button.style.cursor = 'not-allowed';

                button.innerHTML = `
                    <span>Ver</span>
                    <span style="font-size: 13px;">JSON</span>
                `;
                }

            try {
                const fila = button.closest('tr');
                const nFact = fila.querySelector('td:nth-child(2)').textContent;
                const cuvCell = fila.querySelector('.cuv-cell');
                const cuvValue = cuvCell ? cuvCell.textContent.trim() : '';
                const tieneCUV = cuvValue !== '' && cuvValue !== null && cuvValue !== undefined;

                const ejecutarRipsUrl = `https://${host}:9876/api/sql/ejecutarRips?Nfact=${nFact}`;
                const ripsResp = await fetch(ejecutarRipsUrl);
                if (!ripsResp.ok) {
                    const errorText = await ripsResp.text();
                    const erroresPersonalizados = [
                        {
                            condicion: (msg) => msg.includes("tipoDocumentoIdentificacion"),
                            mensaje: "No se puede insertar NULL en la columna 'tipoDocumentoIdentificacion', tabla 'IPSoft100_ST.dbo.Rips_Procedimientos"
                        },
                    ];

                    let mensajeAmigable = erroresPersonalizados.find(e => e.condicion(errorText))?.mensaje;
                    if (!mensajeAmigable) {
                        mensajeAmigable = errorText.length > 150 ? errorText.slice(0, 150) + "..." : errorText;
                    }

                    showToast('Error', `No se pudo ejecutar Rips: ${mensajeAmigable}`, 'error');
                    return;
                }

                const url = `https://${host}:9876/certificados/generarjson/${idMovDoc}`;
                const response = await fetch(url);
                if (!response.ok) {
                    const errorText = await response.text();
                    showToast('Error', `No se pudo obtener el JSON: ${errorText}`, 'error');
                    return;
                }

                const data = await response.json();
                const pretty = JSON.stringify(data, null, 2);
                
                const totalLines = pretty.split('\n').length;
                const shouldCollapseArrays = totalLines >= 5000;

                const overlay = document.createElement('div');
                overlay.style.position = 'fixed';
                overlay.style.top = '0';
                overlay.style.left = '0';
                overlay.style.width = '100%';
                overlay.style.height = '100%';
                overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.1)';
                overlay.style.zIndex = '9998';
                overlay.style.display = 'flex';
                overlay.style.justifyContent = 'center';
                overlay.style.alignItems = 'flex-start';
                overlay.style.paddingTop = '5%';

                const modal = document.createElement('div');
                modal.style.backgroundColor = '#fff';
                modal.style.border = '1px solid #ccc';
                modal.style.padding = '0';
                modal.style.zIndex = '9999';
                modal.style.maxHeight = '90vh';
                modal.style.overflow = 'hidden';
                modal.style.width = '70%';
                modal.style.maxWidth = '1200px';
                modal.style.boxShadow = '0 2px 10px rgba(0,0,0,0.3)';
                modal.style.borderRadius = '8px';
                modal.style.position = 'relative';

                modal.innerHTML = `
                    <style>
                        .collapse-btn {
                            background: none;
                            border: none;
                            color: #007bff;
                            cursor: pointer;
                            font-family: monospace;
                            font-size: 12px;
                            margin-right: 5px;
                            padding: 0;
                            text-decoration: underline;
                        }
                        .collapse-btn:hover {
                            color: #0056b3;
                        }
                        .collapsed-content {
                            color: #999;
                            font-style: italic;
                        }
                        .json-line {
                            line-height: 1.4;
                        }
                    </style>
                    <div class="verjson-header">
                        <p class="verjson-title">JSON de: ${nFact} ${shouldCollapseArrays ? '(' + totalLines + ' l√≠neas)' : ''}</p>
                        <div class="verjson-toolbar">
                            <input type="text" id="jsonSearchInput" class="verjson-search" placeholder="Buscar en el JSON...">
                            <button id="prevMatch" class="navbtn" style="display: none;">‚Üê</button>
                            <div id="matchCounter">0 de 0</div>
                            <button id="nextMatch" class="navbtn" style="display: none;">‚Üí</button>
                            <button id="toggleEditMode" class="navbtn" ${tieneCUV ? 'disabled style="background-color: #ccc; cursor: not-allowed;" title="No se puede editar: factura tiene CUV asignado"' : ''}> ${tieneCUV ? 'Edici√≥n bloqueada' : 'Editar JSON'} </button>
                            <button class="cerrarjson" onclick="cerrarModal()">Cerrar</button>
                        </div>
                    </div>

                    <div id="jsonViewer" style="font-family: monospace; white-space: pre-wrap; background: #f8f8f8; padding: 1rem; border-radius: 8px; max-height: 70vh; overflow: auto;"></div>
                    <div id="editModeButtons" style="display: none; padding: 5px; text-align: center; border-top: 1px solid #ddd;">
                        <button id="guardarCambios" class="navbtn" style="margin-right: 10px;">Guardar cambios</button>
                        <button id="cancelarCambios" class="navbtn" style="background-color: #dc3545;">Cancelar</button>
                    </div>
                `;

                overlay.appendChild(modal);
                document.body.appendChild(overlay);


                let overlayClickHandler, modalClickHandler, handleEscape;
                let searchInputHandler, toggleEditHandler, guardarCambiosHandler, cancelarCambiosHandler;
                let prevMatchHandler, nextMatchHandler, searchKeydownHandler;


                let isEditMode = false;
                let originalData = structuredClone(data);
                let currentData = structuredClone(data);


                const jsonViewer = document.getElementById('jsonViewer');
                const toggleEditButton = document.getElementById('toggleEditMode');
                const editModeButtons = document.getElementById('editModeButtons');
                const guardarCambiosBtn = document.getElementById('guardarCambios');
                const cancelarCambiosBtn = document.getElementById('cancelarCambios');
                const searchInput = document.getElementById('jsonSearchInput');
                const matchCounter = document.getElementById('matchCounter');
                const prevMatchButton = document.getElementById('prevMatch');
                const nextMatchButton = document.getElementById('nextMatch');

                let matches = [];
                let currentMatchIndex = -1;
                let originalContent = pretty;

                let collapsedState = new Map();

                function limpiarMemoria() {
                    console.log('üßπ Iniciando limpieza de memoria...');
                    
                    if (document.body.contains(overlay)) {
                        document.body.removeChild(overlay);
                    }
                    
                    if (overlayClickHandler) overlay.removeEventListener('click', overlayClickHandler);
                    if (modalClickHandler) modal.removeEventListener('click', modalClickHandler);
                    if (handleEscape) document.removeEventListener('keydown', handleEscape);
                    if (searchInputHandler) searchInput.removeEventListener('input', searchInputHandler);
                    if (toggleEditHandler) toggleEditButton.removeEventListener('click', toggleEditHandler);
                    if (guardarCambiosHandler) guardarCambiosBtn.removeEventListener('click', guardarCambiosHandler);
                    if (cancelarCambiosHandler) cancelarCambiosBtn.removeEventListener('click', cancelarCambiosHandler);
                    if (prevMatchHandler) prevMatchButton.removeEventListener('click', prevMatchHandler);
                    if (nextMatchHandler) nextMatchButton.removeEventListener('click', nextMatchHandler);
                    if (searchKeydownHandler) searchInput.removeEventListener('keydown', searchKeydownHandler);

                    originalData = null;
                    currentData = null;
                    originalContent = null;
                    matches = null;
                    collapsedState.clear();
                    collapsedState = null;
                    
                    jsonViewer.innerHTML = '';
                    modal.innerHTML = '';
                    
                    delete window.cerrarModal;
                    delete window.toggleArray;
                    
                    console.log('‚úÖ Limpieza de memoria completada');
                }

                window.cerrarModal = function() {
                    limpiarMemoria();
                };

                overlayClickHandler = function(e) {
                    if (e.target === overlay) {
                        cerrarModal();
                    }
                };

                modalClickHandler = function(e) {
                    e.stopPropagation();
                };

                handleEscape = function(e) {
                    if (e.key === 'Escape') {
                        cerrarModal();
                    }
                };

                overlay.addEventListener('click', overlayClickHandler);
                modal.addEventListener('click', modalClickHandler);
                document.addEventListener('keydown', handleEscape);

                function shouldCollapseArray(path) {
                    return shouldCollapseArrays; 
                }

                function renderViewJSONWithCollapse(jsonData) {
                    return `<div id="jsonContent">${renderCollapsibleJSON(jsonData, '', 0, false)}</div>`;
                }

                function renderEditJSONWithCollapse(jsonData) {
                    return `<div id="jsonContent">${renderCollapsibleJSON(jsonData, '', 0, true)}</div>`;
                }

                function renderCollapsibleJSON(obj, path = '', indent = 0, editMode = false) {
                    const spacer = '&nbsp;'.repeat(indent * 2);
                    let html = '';

                    if (Array.isArray(obj)) {
                        const arrayId = `array_${path.replace(/\./g, '_')}`;
                        const shouldCollapse = shouldCollapseArray(path);
                        const isCollapsed = collapsedState.get(arrayId) ?? shouldCollapse;
                        
                        const toggleText = isCollapsed ? '[+]' : '[-]';
                        const itemCount = obj.length;
                        
                        html += `<button class="collapse-btn" onclick="toggleArray('${arrayId}'); return false;">${toggleText}</button>[`;
                        
                        if (isCollapsed) {
                            html += `<span class="collapsed-content"> ... ${itemCount} elementos </span>`;
                        } else {
                            html += '<br>';
                            obj.forEach((item, index) => {
                                const currentPath = path ? `${path}[${index}]` : `[${index}]`;
                                const comma = index < obj.length - 1 ? ',' : '';
                                html += `<div class="json-line">${spacer}&nbsp;&nbsp;${renderCollapsibleJSON(item, currentPath, indent + 1, editMode)}${comma}</div>`;
                            });
                            html += `${spacer}`;
                        }
                        
                        html += `]`;
                        html = `<span id="${arrayId}">${html}</span>`;
                        
                    } else if (typeof obj === 'object' && obj !== null) {
                        html += '{<br>';
                        const entries = Object.entries(obj);
                        entries.forEach(([key, value], index) => {
                            const currentPath = path ? `${path}.${key}` : key;
                            html += `<div class="json-line">${spacer}&nbsp;&nbsp;"<span class="json-key">${key}</span>": ${renderCollapsibleJSON(value, currentPath, indent + 1, editMode)}${index < entries.length - 1 ? ',' : ''}</div>`;
                        });
                        html += `${spacer}}`;
                    } else {
                        if (editMode) {
                            const val = obj !== null ? obj : 'null';
                            
                            const esConsecutivo = path.includes('consecutivo') || path.endsWith('consecutivo');
                            const esNfact = path.includes('numFactura') || path.endsWith('numFactura');
                            const esNumDocumento = path.includes('numDocumentoIdObligado') || path.endsWith('numDocumentoIdObligado');
                            const deshabilitado = esConsecutivo || esNfact || esNumDocumento;

                            const disabledAttr = deshabilitado ? 'disabled' : '';
                            const estiloDeshabilitado = deshabilitado ? 'background-color: #f5f5f5; color: #666; cursor: not-allowed; border: 1px solid #ddd;' : '';
                            const titulo = deshabilitado ? 'Campo no editable' : '';

                            html += `<input class="json-input" 
                                            type="text" 
                                            value="${val}" 
                                            data-path="${path}" 
                                            ${disabledAttr}
                                            style="width: auto; max-width: 200px; display: inline-block; font-size: 12px; font-family: monospace; ${estiloDeshabilitado}" 
                                            title="${titulo}" />`;
                        } else {
                            const val = obj !== null ? JSON.stringify(obj) : 'null';
                            html += `<span class="json-value">${val}</span>`;
                        }
                    }

                    return html;
                }

                window.toggleArray = function(arrayId) {
                    const isCurrentlyCollapsed = collapsedState.get(arrayId) ?? false;
                    collapsedState.set(arrayId, !isCurrentlyCollapsed);
                    
                    if (isEditMode) {
                        updateJSONData();
                        jsonViewer.innerHTML = renderEditJSONWithCollapse(currentData);
                    } else {
                        jsonViewer.innerHTML = renderViewJSONWithCollapse(currentData);
                        
                        if (searchInput.value.trim()) {
                            searchInputHandler();
                        }
                    }
                };

                function renderViewJSON(jsonData) {
                    if (shouldCollapseArrays) {
                        return renderViewJSONWithCollapse(jsonData);
                    } else {
                        return `<pre id="jsonContent" style="margin: 0; padding: 0;">${JSON.stringify(jsonData, null, 2)}</pre>`;
                    }
                }

                function renderEditJSON(jsonData) {
                    if (shouldCollapseArrays) {
                        return renderEditJSONWithCollapse(jsonData);
                    } else {
                        return renderEditableJSON(jsonData);
                    }
                }

                function renderEditableJSON(obj, path = '', indent = 0) {
                    const spacer = '&nbsp;'.repeat(indent * 2);
                    let html = '';

                    if (Array.isArray(obj)) {
                        html += '[<br>';
                        obj.forEach((item, index) => {
                            const currentPath = path ? `${path}[${index}]` : `[${index}]`;
                            const comma = index < obj.length - 1 ? ',' : '';
                            html += `<div class="json-line">${spacer}&nbsp;&nbsp;${renderEditableJSON(item, currentPath, indent + 1)}${comma}</div>`;
                        });
                        html += `${spacer}]`;
                    } else if (typeof obj === 'object' && obj !== null) {
                        html += '{<br>';
                        const entries = Object.entries(obj);
                        entries.forEach(([key, value], index) => {
                            const currentPath = path ? `${path}.${key}` : key;
                            html += `<div class="json-line">${spacer}&nbsp;&nbsp;"<span class="json-key">${key}</span>": ${renderEditableJSON(value, currentPath, indent + 1)}${index < entries.length - 1 ? ',' : ''}</div>`;
                        });
                        html += `${spacer}}`;
                    } else {
                        const val = obj !== null ? obj : 'null';
                        
                        const esConsecutivo = path.includes('consecutivo') || path.endsWith('consecutivo');
                        const esNfact = path.includes('numFactura') || path.endsWith('numFactura');
                        const esNumDocumento = path.includes('numDocumentoIdObligado') || path.endsWith('numDocumentoIdObligado');
                        const deshabilitado = esConsecutivo || esNfact || esNumDocumento;

                        const disabledAttr = deshabilitado ? 'disabled' : '';
                        const estiloDeshabilitado = deshabilitado ? 'background-color: #f5f5f5; color: #666; cursor: not-allowed; border: 1px solid #ddd;' : '';
                        const titulo = deshabilitado ? 'Campo no editable' : '';

                        html += `<input class="json-input" 
                                        type="text" 
                                        value="${val}" 
                                        data-path="${path}" 
                                        ${disabledAttr}
                                        style="width: auto; max-width: 200px; display: inline-block; font-size: 12px; font-family: monospace; ${estiloDeshabilitado}" 
                                        title="${titulo}" />`;
                    }

                    return html;
                }

                function toggleEditMode() {
                    isEditMode = !isEditMode;
                    
                    if (isEditMode) {
                        originalData = structuredClone(currentData);
                        toggleEditButton.textContent = 'Ver JSON';
                        toggleEditButton.style.backgroundColor = '#28a745';
                        editModeButtons.style.display = 'block';
                        searchInput.disabled = true;
                        searchInput.style.opacity = '0.5';
                        prevMatchButton.style.display = 'none';
                        nextMatchButton.style.display = 'none';
                        matchCounter.textContent = 'Modo edici√≥n';
                        jsonViewer.style.padding = '1rem';
                        jsonViewer.innerHTML = renderEditJSON(currentData);
                    } else {
                        toggleEditButton.textContent = 'Editar JSON';
                        toggleEditButton.style.backgroundColor = '#9b87f5';
                        editModeButtons.style.display = 'none';
                        searchInput.disabled = false;
                        searchInput.style.opacity = '1';
                        matchCounter.textContent = '0 de 0';
                        jsonViewer.style.padding = '1rem';
                        jsonViewer.innerHTML = renderViewJSON(currentData);
                        originalContent = JSON.stringify(currentData, null, 2);
                        searchInput.value = '';
                        matches = [];
                        currentMatchIndex = -1;
                    }
                }

                function updateJSONData() {
                    const inputs = jsonViewer.querySelectorAll('.json-input');
                    inputs.forEach(input => {
                        const path = input.dataset.path;
                        const raw = input.value.trim();

                        let value;
                        if (raw.toLowerCase() === 'null') {
                            value = null;
                        } else if (raw === '') {
                            value = '';
                        } else if (/^-?\d+(\.\d+)?$/.test(raw) && !/^0\d/.test(raw)) {
                            value = Number(raw);
                        } else {
                            value = raw;
                        }

                        setNestedValue(currentData, path, value);
                    });
                }

                function setNestedValue(obj, path, value) {
                    const keys = path.split(/[\.\[\]]+/).filter(k => k);
                    let current = obj;
                    
                    for (let i = 0; i < keys.length - 1; i++) {
                        const key = keys[i];
                        if (!(key in current)) {
                            current[key] = {};
                        }
                        current = current[key];
                    }
                    
                    const lastKey = keys[keys.length - 1];
                    current[lastKey] = value;
                }

                function obtenerCambios(original, actual, path = '') {
                    let cambios = {};
                    const allKeys = new Set([
                        ...Object.keys(original || {}),
                        ...Object.keys(actual || {})
                    ]);

                    for (const key of allKeys) {
                        const fullPath = path ? `${path}.${key}` : key;
                        const originalValue = original ? original[key] : undefined;
                        const actualValue = actual ? actual[key] : undefined;

                        if (typeof actualValue === 'object' && actualValue !== null && !Array.isArray(actualValue) &&
                            typeof originalValue === 'object' && originalValue !== null && !Array.isArray(originalValue)) {
                            
                            const nestedChanges = obtenerCambios(originalValue, actualValue, fullPath);
                            if (Object.keys(nestedChanges).length > 0) {
                                Object.assign(cambios, nestedChanges);
                            }
                        } else if (actualValue !== originalValue) {
                            cambios[fullPath] = actualValue;
                        }
                    }

                    return cambios;
                }

                function getDiffUsuarios(originalUsuarios, editedUsuarios) {
                    const diffUsuarios = [];

                    for (const edited of editedUsuarios) {
                        const original = originalUsuarios.find(o => o.consecutivo === edited.consecutivo);
                        let tieneChangesCamposPrincipales = false;
                        let tieneChangesServicios = false;
                        const serviciosDiff = {};

                        for (const key in edited) {
                            if (key === "servicios" || key === "consecutivo") continue;
                            if (!original || edited[key] != original[key]) {
                                tieneChangesCamposPrincipales = true;
                                break;
                            }
                        }

                        if (edited.servicios && original?.servicios) {
                            for (const tipo in edited.servicios) {
                                const editedList = edited.servicios[tipo] || [];
                                const originalList = original.servicios[tipo] || [];

                                const cambiosTipo = [];

                                for (const item of editedList) {
                                    const origItem = originalList.find(o => o.consecutivo === item.consecutivo);
                                    let tieneChangesEnItem = false;
                                    
                                    for (const key in item) {
                                        if (!origItem || item[key] != origItem[key]) {
                                            tieneChangesEnItem = true;
                                            break;
                                        }
                                    }
                                    
                                    if (tieneChangesEnItem) {
                                        cambiosTipo.push(item); 
                                    }
                                }

                                if (cambiosTipo.length > 0) {
                                    serviciosDiff[tipo] = cambiosTipo;
                                    tieneChangesServicios = true;
                                }
                            }
                        }

                        if (tieneChangesCamposPrincipales || tieneChangesServicios) {
                            const usuarioCompleto = {
                                consecutivo: edited.consecutivo,
                                tipoDocumentoIdentificacion: edited.tipoDocumentoIdentificacion,
                                numDocumentoIdentificacion: edited.numDocumentoIdentificacion,
                                tipoUsuario: edited.tipoUsuario,
                                fechaNacimiento: edited.fechaNacimiento,
                                codSexo: edited.codSexo,
                                codPaisResidencia: edited.codPaisResidencia,
                                codMunicipioResidencia: edited.codMunicipioResidencia,
                                codZonaTerritorialResidencia: edited.codZonaTerritorialResidencia,
                                incapacidad: edited.incapacidad,
                                codPaisOrigen: edited.codPaisOrigen
                            };

                            if (tieneChangesServicios) {
                                usuarioCompleto.servicios = serviciosDiff;
                            }

                            diffUsuarios.push(usuarioCompleto);
                        }
                    }

                    return diffUsuarios;
                }

                toggleEditHandler = toggleEditMode;

                guardarCambiosHandler = async () => {
                    if (tieneCUV) {
                        showToast('Advertencia', `No se puede editar el JSON: la factura tiene CUV asignado (${cuvValue})`, 'warning');
                        return;
                    }

                    if (!tieneCUV) {
                        const idEstadoValidacion = 2;
                        actualizarSoloEstado(nFact, idEstadoValidacion);
                    }

                    updateJSONData();

                    const cambios = {};

                    if (currentData.numFactura != originalData.numFactura) {
                        cambios.numFactura = currentData.numFactura;
                    }
                    if (currentData.numDocumentoIdObligado != originalData.numDocumentoIdObligado) {
                        cambios.numDocumentoIdObligado = currentData.numDocumentoIdObligado;
                    }
                    if (currentData.tipoNota != originalData.tipoNota) {
                        cambios.tipoNota = currentData.tipoNota;
                    }
                    if (currentData.numNota != originalData.numNota) {
                        cambios.numNota = currentData.numNota;
                    }

                    const usuariosDiff = getDiffUsuarios(originalData.usuarios, currentData.usuarios);
                    if (usuariosDiff.length > 0) {
                        cambios.usuarios = usuariosDiff;
                    }

                    if (Object.keys(cambios).length === 0) {
                        showToast('Info', 'No se detectaron cambios', 'info');
                        return;
                    }

                    console.log('üöÄ ===== ENVIANDO SOLO CAMBIOS AL BACKEND =====');
                    console.log(JSON.stringify(cambios, null, 2));
                    console.log('üìä Tama√±o:', JSON.stringify(cambios).length, 'caracteres');
                    console.log('===============================================');

                    try {
                        const host = window.location.hostname;
                        const url = `https://${host}:9876/api/sql/actualizarCampos?idMovDoc=${idMovDoc}`;

                        const fetchOptions = {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            },
                            body: JSON.stringify(cambios)
                        };

                        const response = await fetch(url, fetchOptions);

                        if (response.ok) {
                            const responseText = await response.text();
                            showToast('√âxito', 'Cambios guardados correctamente', 'success');
                            originalData = structuredClone(currentData);
                            toggleEditMode();
                        } else {
                            const errorText = await response.text();
                            showToast('Error', `Error al guardar cambios: ${errorText}`, 'error');
                        }
                    } catch (e) {
                        console.error("‚ùå Error en fetch:", e);
                        showToast('Error', `Fallo la petici√≥n: ${e.message}`, 'error');
                    }
                };


                cancelarCambiosHandler = () => {
                    currentData = structuredClone(originalData);
                    toggleEditMode();
                    showToast('Info', 'Cambios cancelados', 'info');
                };

                jsonViewer.innerHTML = renderViewJSON(currentData);

                searchInputHandler = () => {
                    if (isEditMode) return;
                    
                    const searchTerm = searchInput.value.trim().toLowerCase();
                    const jsonContent = document.getElementById('jsonContent');
                    
                    matches.length = 0;
                    currentMatchIndex = -1;
                    
                    if (!searchTerm) {
                        jsonViewer.innerHTML = renderViewJSON(currentData);
                        updateMatchCounter();
                        return;
                    }
                    
                    const searchContent = shouldCollapseArrays ? 
                        JSON.stringify(currentData, null, 2) : 
                        jsonContent.textContent;
                        
                    const lines = searchContent.split('\n');
                    const highlightedLines = [];
                    
                    lines.forEach((line, index) => {
                        if (line.toLowerCase().includes(searchTerm)) {
                            matches.push(index);
                            const highlightedLine = line.replace(
                                new RegExp(`(${escapeRegExp(searchTerm)})`, 'gi'), 
                                '<mark class="match" data-line="' + index + '">$1</mark>'
                            );
                            highlightedLines.push(highlightedLine);
                        } else {
                            highlightedLines.push(line);
                        }
                    });
                    
                    if (shouldCollapseArrays) {
                        jsonContent.innerHTML = `<pre style="margin: 0;">${highlightedLines.join('\n')}</pre>`;
                    } else {
                        jsonContent.innerHTML = highlightedLines.join('\n');
                    }
                    
                    updateMatchCounter();
                };

                function escapeRegExp(string) {
                    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                }

                const updateMatchCounter = () => {
                    if (matches.length > 0) {
                        currentMatchIndex = 0;
                        highlightCurrentMatch();
                        matchCounter.textContent = `${currentMatchIndex + 1} de ${matches.length}`;
                        prevMatchButton.style.display = 'inline';
                        nextMatchButton.style.display = 'inline';
                    } else {
                        matchCounter.textContent = searchInput.value.trim() ? '0 de 0' : '0 de 0';
                        prevMatchButton.style.display = 'none';
                        nextMatchButton.style.display = 'none';
                        const jsonContent = document.getElementById('jsonContent');
                        if (jsonContent) {
                            const currentHighlight = jsonContent.querySelector('.current-match');
                            if (currentHighlight) {
                                currentHighlight.classList.remove('current-match');
                            }
                        }
                    }
                };

                const highlightCurrentMatch = () => {
                    const jsonContent = document.getElementById('jsonContent');
                    if (!jsonContent) return;
                    
                    const previousCurrent = jsonContent.querySelector('.current-match');
                    if (previousCurrent) {
                        previousCurrent.classList.remove('current-match');
                    }
                    
                    const allMatches = jsonContent.querySelectorAll('.match');
                    const matchesInCurrentLine = Array.from(allMatches).filter(
                        match => parseInt(match.dataset.line) === matches[currentMatchIndex]
                    );
                    
                    if (matchesInCurrentLine.length > 0) {
                        matchesInCurrentLine[0].classList.add('current-match');
                        matchesInCurrentLine[0].scrollIntoView({
                            behavior: 'smooth',
                            block: 'center'
                        });
                    }
                };

                prevMatchHandler = () => {
                    if (matches.length > 0 && currentMatchIndex > 0) {
                        currentMatchIndex--;
                        highlightCurrentMatch();
                        matchCounter.textContent = `${currentMatchIndex + 1} de ${matches.length}`;
                    }
                };

                nextMatchHandler = () => {
                    if (matches.length > 0 && currentMatchIndex < matches.length - 1) {
                        currentMatchIndex++;
                        highlightCurrentMatch();
                        matchCounter.textContent = `${currentMatchIndex + 1} de ${matches.length}`;
                    }
                };

                searchKeydownHandler = (e) => {
                    if (e.key === 'Enter' && !isEditMode) {
                        e.preventDefault();
                        if (e.shiftKey) {
                            prevMatchHandler();
                        } else {
                            nextMatchHandler();
                        }
                    }
                };

                searchInput.addEventListener('input', searchInputHandler);
                toggleEditButton.addEventListener('click', toggleEditHandler);
                guardarCambiosBtn.addEventListener('click', guardarCambiosHandler);
                cancelarCambiosBtn.addEventListener('click', cancelarCambiosHandler);
                prevMatchButton.addEventListener('click', prevMatchHandler);
                nextMatchButton.addEventListener('click', nextMatchHandler);
                searchInput.addEventListener('keydown', searchKeydownHandler);

            } catch (error) {
                console.error('Error:', error);
                showToast('Error', `Error al procesar el JSON: ${error.message}`, 'error');
            } finally {
                if (button) {
                    button.disabled = false;
                    button.innerHTML = originalHTML;
                    button.style.opacity = '1';
                    button.style.cursor = 'pointer';
                }
            }
        }

        async function obtenerCUV(nFact) {
            const host = window.location.hostname;
            const url = `https://${host}:9876/api/sql/cuv?nFact=${nFact}`;
            
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    return '';
                }
                const data = await response.json();
                return data.Rips_CUV || '';
            } catch (error) {
                return '';
            }
        }

        async function actualizarCUVEnFila(fila, nFact) {
            const cuvCell = fila.querySelector('.cuv-cell');
            if (cuvCell) {
                const cuv = await obtenerCUV(nFact);

                if (cuv && cuv.trim() !== '') {
                    cuvCell.innerHTML = `
                        <span class="valor-cuv">${cuv}</span>
                        <button class="btn-copiar-cuv" title="Copiar CUV" style="margin-left:5px; cursor:pointer;">üìã</button>
                    `;

                    const copiarBtn = cuvCell.querySelector('.btn-copiar-cuv');
                    copiarBtn.addEventListener('click', () => {
                        copiarAlPortapapeles(cuv)
                            .then(() => showToast('Copiado', `CUV copiado: ${cuv}`, 'success'))
                            .catch(err => showToast('Error', 'No se pudo copiar el CUV', 'error'));
                           
                    });
                    
                } else {
                    cuvCell.innerHTML = '';
                }

                const enviarBtn = fila.querySelector('button[onclick*="enviarPaquete"]');
                const estadoCell = fila.querySelector('.estado-cell');
                fila.classList.remove('fila-verde');

                if (cuv && cuv.trim() !== '') {
                    fila.classList.add('fila-verde');
                    if (enviarBtn) {
                        enviarBtn.disabled = true;
                        enviarBtn.classList.add('button-disabled');
                        enviarBtn.title = 'Ya enviado - CUV: ' + cuv;
                    }
                    if (estadoCell) {
                        estadoCell.textContent = 'Enviado';
                        estadoCell.classList.add('estado-verde');
                    }
                } else {
                    if (enviarBtn) {
                        enviarBtn.disabled = false;
                        enviarBtn.classList.remove('button-disabled');
                        enviarBtn.title = 'Enviar paquete';
                    }
                }
            }
        }

        document.getElementById('facturasForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const submitBtn = e.submitter || document.querySelector('#facturasForm button[type="submit"]');
            const originalHTML = submitBtn ? submitBtn.innerHTML : '';
            
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = 'Buscando...';
                submitBtn.style.opacity = '0.6';
                submitBtn.style.cursor = 'not-allowed';
            }

            try {
                const fechaDesde = document.getElementById('fechaDesde').value;
                const fechaHasta = document.getElementById('fechaHasta').value;

                if (!fechaDesde) {
                    showToast('Error', 'La Fecha Desde es obligatoria.', 'error');
                    return;
                }
                if (!fechaHasta) {
                    showToast('Error', 'La Fecha Hasta es obligatoria.', 'error');
                    return;
                }
                if (new Date(fechaDesde) > new Date(fechaHasta)) {
                    showToast('Error', 'La Fecha Desde no puede ser mayor que la Fecha Hasta.', 'error');
                    return;
                }

                const formData = new FormData(e.target);
                const params = new URLSearchParams();
                for (const [key, value] of formData.entries()) {
                    if (value.trim()) params.append(key, value);
                }

                showToast('Procesando', 'Buscando facturas...', 'success', 2000);

                const response = await fetch(`/filtros/facturas?${params.toString()}`);
                const data = await response.json();

                if (!response.ok) {
                    showToast('Error', typeof data === 'string' ? data : JSON.stringify(data), 'error');
                    return;
                }

                const head = document.getElementById('tablaHead');
                const body = document.getElementById('tablaBody');
                const accionesDiv = document.getElementById('accionesDiv');

                accionesDiv.style.display = 'block';
                head.innerHTML = '';
                body.innerHTML = '';

                if (data.length === 0) {
                    showToast('Error', 'No se encontraron resultados.', 'error')
                    body.innerHTML = `<tr><td colspan="10" class="empty-state">No se encontraron resultados</td></tr>`;
                    return;
                }

                const headers = Object.keys(data[0]).filter(h => h.toLowerCase() !== 'nomcontrato' && h.toLowerCase() !== 'idmovdoc' && h.toLowerCase() !== 'idtercerokey' && h.toLowerCase() !== 'nocontrato');
                head.innerHTML = '<tr><th class="checkbox-cell"><input type="checkbox" id="selectAll" onclick="toggleSelectAll(this)"></th>' +
                    headers.map(h => `<th>${h}</th>`).join('') +
                    '<th class="col-descripcion">Descripci√≥n</th>' + 
                    '<th>Observaciones</th>' +
                    '<th>Estado</th>' +
                    '<th>CUV</th>' +
                    '<th class="accionis">Acciones</th></tr>';

                const filasPromises = data.map(async (row, index) => {
                    const idMovDoc = row.idMovDoc || row.IdMovDoc || row.IDMOVDOC || row.ID || '';
                    const nFact = row.nFact || row.NFact || row.NFACT || row.NoFactura || '';
                    const rowCells = headers.map(h => `<td>${row[h] ?? ''}</td>`).join('');
                    const descripcion = row.descripcion || '';

                    const filaHTML = 
                    `<tr data-nfact="${nFact}">
                        <td class="checkbox-cell"><input type="checkbox" class="filaCheckbox custom-checkbox" value="${idMovDoc}"></td>
                        ${rowCells}
                        <td class="col-descripcion">${descripcion}</td>
                        <td>${row.observaciones || ''}</td>
                        <td class="estado-cell">${row.estado || 'Pendiente'}</td>
                        <td class="cuv-cell"></td>
                        <td>
                        <div class="button-flex">
                            <button class="button button-small button-success" onclick="enviarPaquete('${idMovDoc}', this)">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M22 2L11 13" />
                                    <path d="M22 2L15 22L11 13L2 9L22 2Z" />
                                </svg>
                                Enviar
                            </button>
                            <button class="button button-small button-success" onclick="DescargarPaquete(this)" data-id="${idMovDoc}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                                </svg>
                                Descargar
                                Paquete
                            </button>
                        </div>
                            <div style="display: flex; justify-content: center; align-items: center; gap: 16px; margin-top: 20px;">
                            <button 
                                class="button button-small" 
                                onclick="verJSON('${idMovDoc}')" 
                                style="display: flex; flex-direction: column; align-items: center; min-width: 88px; padding: 8px 12px;">
                                <span>Ver</span>
                                <span style="font-size: 13px;">JSON</span>
                            </button>

                            <button 
                                class="button button-small descargar-logs-btn" 
                                style="display: none; flex-direction: column; align-items: center; min-width: 88px; padding: 8px 18px;" 
                                onclick="descargarLogsGenerales(this)">
                                <span>Descargar</span>
                                <span style="font-size: 13px;">Logs</span>
                            </button>
                            </div>
                        </td>
                    </tr>`;

                    return { html: filaHTML, nFact: nFact };
                });

                const filas = await Promise.all(filasPromises);
                body.innerHTML = filas.map(f => f.html).join('');

                const toast = showToast('Procesando', 'Cargando CUVs...', 'success', 999999, true);

                await procesarFilasEnLotes(filas, body, 30, toast);

                showToast('B√∫squeda completada', `Se encontraron ${data.length} resultados`, 'success');

            } catch (err) {
                showToast('Error', "Error en la solicitud: " + err.message, 'error');
            } finally {
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalHTML;
                    submitBtn.style.opacity = '1';
                    submitBtn.style.cursor = 'pointer';
                }
            }
        });

        async function procesarFilasEnLotes(filas, body, loteSize = 30, toast = null) {
            for (let i = 0; i < filas.length; i += loteSize) {
                const lote = filas.slice(i, i + loteSize);
                const promesas = lote.map(async (filaData, index) => {
                    const fila = body.children[i + index];
                    if (filaData.nFact) {
                        await actualizarCUVEnFila(fila, filaData.nFact);
                    } else {
                        const cuvCell = fila.querySelector('.cuv-cell');
                        const enviarBtn = fila.querySelector('button[onclick*="enviarPaquete"]');
                        if (cuvCell) cuvCell.innerHTML = '';
                        if (enviarBtn) {
                            enviarBtn.disabled = false;
                            enviarBtn.classList.remove('button-disabled');
                        }
                    }
                });

                await Promise.all(promesas);

                if (toast) {
                    const progreso = Math.min(100, Math.round(((i + lote.length) / filas.length) * 100));
                    actualizarToastProgreso(toast, progreso);
                }
            }

            if (toast) {
                actualizarToastProgreso(toast, 100);
                const mensaje = toast.querySelector('.toast-content p');
                if (mensaje) mensaje.textContent = 'CUVs Cargados correctamente';

                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.classList.add('fadeOut');
                        setTimeout(() => toast.remove(), 300);
                    }
                }, 3000); 
            }
        }


        function toggleSelectAll(checkbox) {
            const checkboxes = document.querySelectorAll('.filaCheckbox');
            checkboxes.forEach(cb => cb.checked = checkbox.checked);
        }

        function seleccionarPorEstado(tipo) {
            const filas = document.querySelectorAll('#tablaBody tr');
            let totalSeleccionadas = 0;

            filas.forEach(fila => {
                const estado = fila.querySelector('.estado-cell')?.textContent?.toLowerCase().trim();
                const checkbox = fila.querySelector('.filaCheckbox');

                if (!checkbox) return;

                switch (tipo) {
                    case 'todos':
                        checkbox.checked = true;
                        totalSeleccionadas++;
                        fila.style.display = '';
                        break;
                    case 'pendientes':
                        const esPendiente = estado === 'pendiente';
                        checkbox.checked = esPendiente;
                        fila.style.display = esPendiente ? '' : 'none';
                        if (esPendiente) totalSeleccionadas++;
                        break;

                    case 'enviados':
                        const esEnviado = estado === 'enviado';
                        checkbox.checked = esEnviado;
                        fila.style.display = esEnviado ? '' : 'none';
                        if (esEnviado) totalSeleccionadas++;
                        break;
                    case 'ninguno':
                        checkbox.checked = false;
                        fila.style.display = '';
                        break;
                }
            });
            
            const selectAllCheckbox = document.getElementById('selectAll');
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = tipo === 'todos';
            }

            verificarCheckboxes();
        }

        document.querySelectorAll('.button-secondary').forEach(btn => {
        btn.addEventListener('click', function () {

            document.querySelectorAll('.button-secondary').forEach(b => b.classList.remove('activo'));

            if (!this.textContent.toLowerCase().includes('deseleccionar')) {
            this.classList.add('activo');
            }
        });
        });

        function copiarAlPortapapeles(texto) {
            if (navigator.clipboard && window.isSecureContext) {
                return navigator.clipboard.writeText(texto);
            } 

            else {
                return new Promise((resolve, reject) => {
                    const textarea = document.createElement('textarea');
                    textarea.value = texto;
                    textarea.style.position = 'fixed';
                    textarea.style.left = '-9999px';
                    textarea.style.top = '-9999px';
                    
                    document.body.appendChild(textarea);
                    textarea.focus();
                    textarea.select();
                    
                    try {
                        const exitoso = document.execCommand('copy');
                        document.body.removeChild(textarea);
                        
                        if (exitoso) {
                            resolve();
                        } else {
                            reject(new Error('No se pudo copiar'));
                        }
                    } catch (err) {
                        document.body.removeChild(textarea);
                        reject(err);
                    }
                });
            }
        }

        async function cargarTerceros() {
            try {
                const response = await fetch('/filtros/terceros');
                const data = await response.json();
                const select = document.getElementById('idTercero');

                data.forEach(tercero => {
                    const option = document.createElement('option');
                    option.value = tercero.idTerceroKey;
                    option.textContent = tercero.nomTercero;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error("Error al cargar terceros:", error);
            }
        }
        

        function verificarCheckboxes() {
            const checkboxes = document.querySelectorAll('.filaCheckbox');
            const descargarPaquetesBtn = document.getElementById('DescargarPaquetesBtn');
            const enviarPaquetesBtn = document.getElementById('enviarPaquetesBtn');

            const cantidadSeleccionados = Array.from(checkboxes).filter(checkbox => checkbox.checked).length;

            descargarPaquetesBtn.disabled = cantidadSeleccionados < 2; 

            enviarPaquetesBtn.disabled = cantidadSeleccionados < 2;
        }

        function descargarLogsGenerales(btn) {
            const url = btn.dataset.downloadUrl;
            const filename = btn.dataset.filename || 'logs.txt';

            if (!url) {
                alert('No hay logs disponibles.');
                return;
            }

            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();

            URL.revokeObjectURL(url);
            delete btn.dataset.downloadUrl;
        }

        async function agregarCUVCompleto(nFact, cuv, idEstadoValidacion) {
            let agregadoExitoso = false;
            
            const urlAgregar = `https://${host}:9876/api/sql/agregarcuv?nFact=${nFact}&ripsCuv=${cuv}`;
            try {
                const agregarResponse = await fetch(urlAgregar, { method: 'POST' });
                if (agregarResponse.ok) {
                    console.log(`‚úÖ CUV agregado en Factura Final para NFact ${nFact}`);
                    agregadoExitoso = true;
                } else {
                    console.error('‚ùå Error al agregar CUV para Factura Final');
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Error en la solicitud agregarcuv:', error);
                return false;
            }

            if (agregadoExitoso) {
                const urlActualizar = `https://${host}:9876/api/sql/actualizarcuvrips?nFact=${nFact}&cuv=${cuv}&idEstadoValidacion=${idEstadoValidacion}`;
                try {
                    const actualizarResponse = await fetch(urlActualizar, { 
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    if (actualizarResponse.ok) {
                        console.log(`‚úÖ CUV agregado en Rips_Transaccion para NFact ${nFact} (Estado: ${idEstadoValidacion})`);
                    } else {
                        const errorText = await actualizarResponse.text();
                        console.error('‚ùå Error al agregar CUV en Rips_Transaccion:', errorText);

                    }
                } catch (error) {
                    console.error('‚ùå Error en la solicitud agregarcuvrips:', error);

                }
            }

            return agregadoExitoso;
        }

        async function actualizarSoloEstado(nFact, idEstadoValidacion) {
            try {
                const urlActualizar = `https://${host}:9876/api/sql/actualizarcuvrips?nFact=${nFact}&cuv=&idEstadoValidacion=${idEstadoValidacion}`;
                const response = await fetch(urlActualizar, { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    console.log(`‚úÖ Estado actualizado a ${idEstadoValidacion} para NFact ${nFact}`);
                    return true;
                } else {
                    const errorText = await response.text();
                    console.error('‚ùå Error al actualizar estado:', errorText);
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Error en la solicitud de actualizaci√≥n de estado:', error);
                return false;
            }
        }

        async function obtenerEstadoValidacion(nFact) {
            const host = window.location.hostname;
            const url = `https://${host}:9876/api/sql/estadovalidacion?nFact=${nFact}`;
            
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    console.error('Error al consultar estado de validaci√≥n:', response.status);
                    return null;
                }
                const data = await response.json(); 
                return data.idEstadoValidacion;
            } catch (error) {
                console.error('Error al obtener estado de validaci√≥n:', error);
                return null;
            }
        }

        async function enviarPaquetes() {
            const boton = document.getElementById('enviarPaquetesBtn');
            const textoOriginal = boton.innerHTML;
            const boton2 = document.getElementById('botonBuscar');
            const textoOriginal2 = boton2.innerHTML;

            const boton3 = document.getElementById('DescargarPaquetesBtn')

            boton.disabled = true;
            boton.innerHTML = 'Enviando...';
            boton.style.opacity = '0.6';
            boton.style.cursor = 'not-allowed';

            boton2.disabled = true;
            boton2.style.opacity = '0.6';
            boton2.style.cursor = 'not-allowed';

            boton3.disabled = true;
            boton3.style.opacity = '0.6';
            boton3.style.cursor = 'not-allowed';



            try {
                const checkboxes = document.querySelectorAll('.filaCheckbox:checked');

                if (checkboxes.length === 0) {
                    showToast('Error', 'No hay facturas seleccionadas', 'error');
                    return;
                }

                toast = showToast('Procesando', `Enviando ${checkboxes.length} paquetes...`, 'success', 30000, true);
                actualizarToastProgreso(toast, 0)

                const documentosSeleccionados = Array.from(checkboxes).map(cb => {
                    const fila = cb.closest('tr');
                    const idMovDoc = cb.value;
                    return { idMovDoc, fila };
                });

                const host = window.location.hostname;
                const token = sessionStorage.getItem('token'); 


                for (const doc of documentosSeleccionados) {
                    const resultadoDiv = doc.fila.querySelector('td:nth-last-child(5)');
                    const observacionesTd = doc.fila.querySelector('td:nth-last-child(4)');
                    const nFact = doc.fila.querySelector('td:nth-child(2)').textContent;
                    const logsButton = doc.fila.querySelector('.descargar-logs-btn');
                    const cuvTd = doc.fila.querySelector('td:nth-last-child(2)');
                    const cuvValor = cuvTd?.textContent?.trim();

                    if (cuvValor && cuvValor.length > 0) {
                        showToast('Advertencia', `La factura ${nFact} ya tiene un CUV registrado. No ser√° procesada.`, 'warning');
                        continue; 
                    }
                    
                    try {
                        const ejecutarRipsUrl = `https://${host}:9876/api/sql/ejecutarRips?Nfact=${nFact}`;
                        const ejecutarRipsResponse = await fetch(ejecutarRipsUrl);
                        if (!ejecutarRipsResponse.ok) {
                            const errorText = await ejecutarRipsResponse.text();
                            resultadoDiv.textContent = `Error al ejecutar Rips: ${errorText}`;
                            showToast('Error', `El paquete ${nFact} fue rechazado`, 'error');
                            doc.fila.classList.add('error-row');
                            continue;
                        }

                        const jsonResponse = await fetch(`https://${host}:9876/certificados/generarjson/${doc.idMovDoc}`);
                        if (!jsonResponse.ok) {
                            const errorText = await jsonResponse.text();
                            resultadoDiv.textContent = `Error al obtener JSON: ${errorText}`;
                            showToast('Error', `El paquete ${nFact} fue rechazado`, 'error');
                            doc.fila.classList.add('error-row');
                            continue;
                        }

                        const jsonData = await jsonResponse.json();

                        const xmlResponse = await fetch(`https://${host}:9876/api/validador/base64/${doc.idMovDoc}`);
                        if (!xmlResponse.ok) {
                            const errorText = await xmlResponse.text();
                            resultadoDiv.textContent = `Error al obtener XML: ${errorText}`;
                            showToast('Error', `El paquete ${nFact} fue rechazado`, 'error');
                            doc.fila.classList.add('error-row');
                            continue;
                        }

                        const xmlText = await xmlResponse.text();

                        const progreso = Math.round(((documentosSeleccionados.indexOf(doc) + 1) / documentosSeleccionados.length) * 100);
                        actualizarToastProgreso(toast, progreso);
                       
                        const payload = {
                            rips: jsonData,
                            xmlFevFile: xmlText
                        };

                        const response = await fetch(`https://${host}:9876/api/validador/subir?nFact=${encodeURIComponent(nFact)}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify(payload)
                        });

                        const responseData = await response.json();



                        if (response.ok && responseData.ResultState === true) {
                
                            const cuv = encodeURIComponent(responseData.CodigoUnicoValidacion || '');
                            
                            if (cuv) {

                                if (logsButton) {
                                    logsButton.style.display = 'none';
                                    delete logsButton.dataset.downloadUrl;
                                    delete logsButton.dataset.filename;
                                }

                                const txtContent = JSON.stringify(responseData, null, 2);
                                
                                await fetch(`https://${host}:9876/api/validador/guardarrespuesta`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({
                                        nFact: nFact,
                                        mensajeRespuesta: txtContent
                                    })
                                });


                                const idEstadoValidacion = 3;
                                const exitoso = await agregarCUVCompleto(nFact, cuv, idEstadoValidacion);
                                if (exitoso) {
                                    await actualizarCUVEnFila(doc.fila, nFact);
                                    showToast('√âxito', `CUV agregado para NFact ${nFact}`, 'success');
                                } else {
                                    showToast('Advertencia', 'Paquete fue exitoso pero no se guard√≥ el CUV', 'warning');
                                }
                            } else {
                                console.warn(`‚ö†Ô∏è Respuesta exitosa sin CUV para NFact ${nFact}`);
                                showToast('Advertencia', `Paquete exitoso pero sin CUV para NFact ${nFact}`, 'warning');
                            }


                        } else {
                            const errores = responseData.ResultadosValidacion || [];
                            let cuvAgregado = false;

                            const errorRVG18 = errores.find(error => error.Codigo === 'RVG18');
                            if (errorRVG18 && errorRVG18.Observaciones) {
                                const ripsCuv = encodeURIComponent(errorRVG18.Observaciones.trim());
                                const url = `https://${host}:9876/api/sql/agregarcuv?nFact=${nFact}&ripsCuv=${ripsCuv}`;

                                const idEstadoValidacion = 3;

                                const exitoso = await agregarCUVCompleto(nFact, ripsCuv, idEstadoValidacion);
                                if (exitoso) {
                                    console.log(`‚úÖ CUV agregado para NFact ${nFact}`);
                                    await actualizarCUVEnFila(doc.fila, nFact);
                                    showToast('√âxito', `CUV agregado para NFact ${nFact}`, 'success');
                                    cuvAgregado = true;

                                    if (logsButton) {
                                        logsButton.style.display = 'none';
                                        delete logsButton.dataset.downloadUrl;
                                        delete logsButton.dataset.filename;
                                    }

                                    const txtContent = JSON.stringify(responseData, null, 2);
                                    const blob = new Blob([txtContent], { type: 'text/plain' });
                                    const downloadUrl = URL.createObjectURL(blob);
                                    const a = document.createElement('a');
                                    a.href = downloadUrl;
                                    a.download = `ResultadosMSPS_${nFact}_A_CUV.txt`;
                                    document.body.appendChild(a);
                                    a.click();
                                    a.remove();
                                    URL.revokeObjectURL(downloadUrl);
                                }
                            }

                            if (!cuvAgregado) {

                                const logsButton = doc.fila.querySelector('.descargar-logs-btn');


                                if (logsButton) {
                                    logsButton.style.display = 'inline-block';

                                    const blob = new Blob([JSON.stringify(responseData, null, 2)], { type: 'text/plain' });
                                    const url = URL.createObjectURL(blob);

                                    logsButton.dataset.downloadUrl = url;
                                    logsButton.dataset.filename = `LogsMSPS_${nFact}.txt`;
                                }
             
                                const estadoActual = await obtenerEstadoValidacion(nFact);

                                if (estadoActual === null) {
                                    console.warn(`No se pudo obtener el estado de validaci√≥n para ${nFact}`);
                                    return;
                                }

                                let idEstadoValidacion;

                                if (estadoActual === 2) {
                                    idEstadoValidacion = 2;
                                } else {
                                    idEstadoValidacion = 4;
                                }
                                const exitoso = await actualizarSoloEstado(nFact, idEstadoValidacion);

                                if (responseData.error) {
                                    const mensajeError = responseData.error;

                                    resultadoDiv.textContent = mensajeError;

                                    showToast('Error', `El paquete ${nFact} fue rechazado`, 'error');
                                }

                                else if (responseData.ResultadosValidacion && Array.isArray(responseData.ResultadosValidacion)) {

                                    const errores = responseData.ResultadosValidacion;

                                    const mensajes = errores.map(error =>
                                        `${error.Clase} \n ${error.Codigo} \n ${error.Descripcion}`
                                    ).join('\n\n');

                                    const observacionesYFuente = errores.map(error =>
                                        `${error.Observaciones} \n  ${error.PathFuente} \n Fuente: ${error.Fuente}`
                                    ).join('\n\n');

                                    if (mensajes.length > 100) {
                                        resultadoDiv.innerHTML = `
                                            <div class="expandable">
                                                <button class="toggle-button" onclick="toggleExpand(this)">
                                                    <span class="arrow">‚ñ∂</span>
                                                </button>
                                                <div class="expand-content">
                                                    <ol class="lista-enumerada">
                                                        ${mensajes.split('\n\n').map(item => `<li>${item.replace(/\n/g, '<br>')}</li>`).join('')}
                                                    </ol>
                                                </div>
                                            </div>`;
                                    } else {
                                        resultadoDiv.textContent = mensajes;
                                    }

                                    if (observacionesYFuente.length > 100) {
                                        observacionesTd.innerHTML = `
                                            <div class="expandable">
                                                <button class="toggle-button" onclick="toggleExpand(this)">
                                                    <span class="arrow">‚ñ∂</span>
                                                </button>
                                                <div class="expand-content">
                                                    <ol class="lista-enumerada">
                                                        ${observacionesYFuente.split('\n\n').map(item => `<li>${item.replace(/\n/g, '<br>')}</li>`).join('')}
                                                    </ol>
                                                </div>
                                            </div>`;
                                    } else {
                                        observacionesTd.textContent = observacionesYFuente;
                                    }

                                    showToast('Error', `El paquete ${nFact} fue rechazado`, 'error');

                                } else {

                                    resultadoDiv.textContent = 'Error desconocido - revisar logs';
                                    observacionesTd.textContent = 'Estructura de respuesta no reconocida';
                                    showToast('Error', `El paquete ${nFact} tuvo un error desconocido`, 'error');
                                }

                                    doc.fila.classList.add('error-row');
                            }
                        }
                    } catch (error) {
                        console.error("Error en enviarPaquetes:", error);
                        resultadoDiv.textContent = 'El token es incorrecto o est√° vac√≠o';
                        doc.fila.classList.add('error-row');
                    }
                }

                

                checkboxes.forEach(cb => cb.checked = false);
                document.getElementById('selectAll').checked = false;
                verificarCheckboxes();

                showToast('Finalizado', `${documentosSeleccionados.length} paquetes procesados`, 'success');
            } catch (error) {
                console.error("Error general al enviar paquetes:", error);
                showToast('Error', `No se pudieron enviar los paquetes: ${error.message}`, 'error');
            } finally {
                boton.innerHTML = textoOriginal;
                boton.disabled = true;
                boton.style.opacity = '1';
                boton.style.cursor = 'pointer';

                boton2.disabled = false;
                boton2.style.opacity = '1';
                boton2.style.cursor = 'pointer';

                boton3.disabled = true;
                boton3.style.opacity = '1';
                boton3.style.cursor = 'pointer';

                setTimeout(() => {
                    toast.classList.add('fadeOut');
                    setTimeout(() => toast.remove(), 300);
                }, 1000);
            }
        }
        
        async function enviarPaquete(idMovDoc, buttonElement) {
            const host = window.location.hostname;
            const token = sessionStorage.getItem('token');
            const botonBuscar = document.getElementById("botonBuscar");

            const originalHTML = buttonElement.innerHTML;
            buttonElement.disabled = true;
            buttonElement.innerHTML = 'Enviando...';
            buttonElement.style.opacity = '0.6';
            buttonElement.style.cursor = 'not-allowed';

            botonBuscar.disabled = true;
            botonBuscar.style.opacity = '0.6';
            botonBuscar.style.cursor = 'not-allowed';

            
            const fila = buttonElement.closest('tr');
            const resultadoDiv = fila.querySelector('td:nth-last-child(5)');
            const observacionesTd = fila.querySelector('td:nth-last-child(4)');
            const descripcionTd = fila.querySelector('td:nth-last-child(6)');
            const nFact = fila.querySelector('td:nth-child(2)').textContent;
            const logsButton = fila.querySelector('.descargar-logs-btn');

            try {

                const toast = showToast('Procesando', `Preparando paquete...`, 'success', 30000, true);
                actualizarToastProgreso(toast, 0);

                const ejecutarRipsUrl = await fetch(`https://${host}:9876/api/sql/ejecutarRips?Nfact=${nFact}`);
                if (!ejecutarRipsUrl.ok) {
                    const errorText = await ejecutarRipsUrl.text();
                    resultadoDiv.textContent = `Error al ejecutar Rips: ${errorText}`;
                    setTimeout(() => {
                        toast.classList.add('fadeOut');
                        setTimeout(() => toast.remove(), 300);
                    }, 1000);
                    showToast('Error', `El paquete ${nFact} fue rechazado`, 'error');
                    fila.classList.add('error-row');
                    return;
                }

                actualizarToastProgreso(toast, 33);

                const jsonResponse = await fetch(`https://${host}:9876/certificados/generarjson/${idMovDoc}`);
                if (!jsonResponse.ok) {
                    const errorText = await jsonResponse.text();
                    resultadoDiv.textContent = `Error al obtener JSON: ${errorText}`;
                    fila.classList.add('error-row');
                    setTimeout(() => {
                        toast.classList.add('fadeOut');
                        setTimeout(() => toast.remove(), 300);
                    }, 1000);
                    showToast('Error', `El paquete ${nFact} fue rechazado`, 'error');
                    return;
                }

                actualizarToastProgreso(toast, 66);

                const jsonData = await jsonResponse.json();

                const xmlResponse = await fetch(`https://${host}:9876/api/validador/base64/${idMovDoc}`);
                if (!xmlResponse.ok) {
                    const errorText = await xmlResponse.text();
                    resultadoDiv.textContent = `Error al obtener XML: ${errorText}`;
                    fila.classList.add('error-row');
                    setTimeout(() => {
                        toast.classList.add('fadeOut');
                        setTimeout(() => toast.remove(), 300);
                    }, 1000);
                    showToast('Error', `El paquete ${nFact} fue rechazado`, 'error');
                    return;
                }

                actualizarToastProgreso(toast, 100);
                setTimeout(() => {
                  toast.classList.add('fadeOut');
                  setTimeout(() => toast.remove(), 300);
                }, 1000);

                showToast('Procesando', `Enviando paquete...`, 'success');

                const xmlText = await xmlResponse.text();

                const payload = {
                    rips: jsonData,
                    xmlFevFile: xmlText
                };

                const response = await fetch(`https://${host}:9876/api/validador/subir?nFact=${encodeURIComponent(nFact)}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(payload)
                });

                const responseData = await response.json();

                if (response.ok && responseData.ResultState === true) {
                   
                    const cuv = encodeURIComponent(responseData.CodigoUnicoValidacion || '');
                    
                    if (cuv) {

                        if (logsButton) {
                            logsButton.style.display = 'none';
                            delete logsButton.dataset.downloadUrl;
                            delete logsButton.dataset.filename;
                        }

                        const txtContent = JSON.stringify(responseData, null, 2);
                        
                        await fetch(`https://${host}:9876/api/validador/guardarrespuesta`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                nFact: nFact,
                                mensajeRespuesta: txtContent
                            })
                        });
                        
                        const idEstadoValidacion = 3;
                        const exitoso = await agregarCUVCompleto(nFact, cuv, idEstadoValidacion);
                        if (exitoso) {
                            await actualizarCUVEnFila(fila, nFact);
                            showToast('√âxito', `CUV agregado para NFact ${nFact}`, 'success');
                        } else {
                            showToast('Advertencia', 'Paquete fue exitoso pero no se guard√≥ el CUV', 'warning');
                        }
                    } else {
                        console.warn(`‚ö†Ô∏è Respuesta exitosa sin CUV para NFact ${nFact}`);
                        showToast('Advertencia', `Paquete exitoso pero sin CUV para NFact ${nFact}`, 'warning');

                    }

                } else {
                    const errores = responseData.ResultadosValidacion || [];
                    let cuvAgregado = false;

                    const errorRVG18 = errores.find(error => error.Codigo === 'RVG18');
                    if (errorRVG18 && errorRVG18.Observaciones) {
                        const ripsCuv = encodeURIComponent(errorRVG18.Observaciones.trim());
                        
                        const idEstadoValidacion = 3;
                        
                        const exitoso = await agregarCUVCompleto(nFact, ripsCuv, idEstadoValidacion);
                        if (exitoso) {
                            console.log(`‚úÖ CUV agregado para NFact ${nFact}`);
                            await actualizarCUVEnFila(fila, nFact);
                            showToast('√âxito', `CUV agregado para NFact ${nFact}`, 'success');
                            cuvAgregado = true;

                            if (logsButton) {
                                logsButton.style.display = 'none';
                                delete logsButton.dataset.downloadUrl;
                                delete logsButton.dataset.filename;
                            }

                            const txtContent = JSON.stringify(responseData, null, 2);
                            const blob = new Blob([txtContent], { type: 'text/plain' });
                            const downloadUrl = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = downloadUrl;
                            a.download = `ResultadosMSPS_${nFact}_A_CUV.txt`;
                            document.body.appendChild(a);
                            a.click();
                            a.remove();
                            URL.revokeObjectURL(downloadUrl);
                        }
                    }

                    if (!cuvAgregado) {

                        if (logsButton) {
                            logsButton.style.display = 'inline-block';

                            const blob = new Blob([JSON.stringify(responseData, null, 2)], { type: 'text/plain' });
                            const url = URL.createObjectURL(blob);

                            logsButton.dataset.downloadUrl = url;
                            logsButton.dataset.filename = `LogsMSPS_${nFact}.txt`;
                        }

                        const estadoActual = await obtenerEstadoValidacion(nFact);

                        if (estadoActual === null) {
                            console.warn(`No se pudo obtener el estado de validaci√≥n para ${nFact}`);
                            return;
                        }

                        const idEstadoValidacion = estadoActual === 2 ? 2 : 4;

                        const exitoso = await actualizarSoloEstado(nFact, idEstadoValidacion);
                        
                        if (responseData.error) {
                            const mensajeError = responseData.error;
                            
                            resultadoDiv.textContent = mensajeError;
                            
                            showToast('Error', `El paquete ${nFact} fue rechazado`, 'error');
                            
                        } else if (responseData.ResultadosValidacion && Array.isArray(responseData.ResultadosValidacion)) {
                            const errores = responseData.ResultadosValidacion;
                            
                            const mensajes = errores.map(error =>
                                `${error.Clase} \n ${error.Codigo} \n ${error.Descripcion}`
                            ).join('\n\n');

                            const observacionesYFuente = errores.map(error =>
                                `${error.Observaciones} \n  ${error.PathFuente} \n Fuente: ${error.Fuente}`
                            ).join('\n\n');

                            if (mensajes.length > 100) {
                                resultadoDiv.innerHTML = `
                                    <div class="expandable">
                                        <button class="toggle-button" onclick="toggleExpand(this)">
                                            <span class="arrow">‚ñ∂</span>
                                        </button>
                                        <div class="expand-content">
                                            <ol class="lista-enumerada">
                                                ${mensajes.split('\n\n').map(item => `<li>${item.replace(/\n/g, '<br>')}</li>`).join('')}
                                            </ol>
                                        </div>
                                    </div>`;
                            } else {
                                resultadoDiv.textContent = mensajes;
                            }

                            if (observacionesYFuente.length > 100) {
                                observacionesTd.innerHTML = `
                                    <div class="expandable">
                                        <button class="toggle-button" onclick="toggleExpand(this)">
                                            <span class="arrow">‚ñ∂</span>
                                        </button>
                                        <div class="expand-content">
                                            <ol class="lista-enumerada">
                                                ${observacionesYFuente.split('\n\n').map(item => `<li>${item.replace(/\n/g, '<br>')}</li>`).join('')}
                                            </ol>
                                        </div>
                                    </div>`;
                            } else {
                                observacionesTd.textContent = observacionesYFuente;
                            }

                            showToast('Error', `El paquete ${nFact} fue rechazado`, 'error');

                    } else {
                            resultadoDiv.textContent = 'Error desconocido - revisar logs';
                            observacionesTd.textContent = 'Estructura de respuesta no reconocida';
                            showToast('Error', `El paquete ${nFact} tuvo un error desconocido`, 'error');
                        }

                        fila.classList.add('error-row');
                    }
                }

            } catch (error) {
                console.error('Error al enviar paquete:', error);
                showToast('Error', `El token es incorrecto o est√° vacio`, 'error')
                resultadoDiv.textContent = 'El token es incorrecto o est√° vac√≠o';
                fila.classList.add('error-row');
            } finally {
                buttonElement.disabled = false;
                buttonElement.innerHTML = originalHTML;
                buttonElement.style.opacity = '1';
                buttonElement.style.cursor = 'pointer';

                botonBuscar.disabled = false;
                botonBuscar.style.opacity = '1';
                botonBuscar.style.cursor = 'pointer';
            }
        }


        async function DescargarPaquetes() {
            const checkboxes = document.querySelectorAll('.filaCheckbox:checked');

            if (checkboxes.length === 0) {
                showToast('Error', 'No hay paquetes seleccionados para descargar', 'error');
                return;
            }

            const botonBuscar = document.getElementById("botonBuscar");
            const botonEnviar = document.getElementById("enviarPaquetesBtn");
            const downloadButton = document.querySelector('#DescargarPaquetesBtn');
            
            

            let originalHTML = '';
            let originalHTML2 = '';


            if (downloadButton) {
                originalHTML = downloadButton.innerHTML;
                downloadButton.disabled = true;
                downloadButton.innerHTML = 'Descargando...';
                downloadButton.style.opacity = '0.6';
                downloadButton.style.cursor = 'not-allowed';
            }

            if (botonBuscar) {
                botonBuscar.disabled = true;
                botonBuscar.style.opacity = '0.6';
                botonBuscar.style.cursor = 'not-allowed';
            }

            if (botonEnviar) {
                botonEnviar.disabled = true;
                botonEnviar.style.opacity = '0.6';
                botonEnviar.style.cursor = 'not-allowed';
            }

            let directoryHandle;
            try {
                try {
                    directoryHandle = await window.showDirectoryPicker();

                    const permiso = await directoryHandle.requestPermission({ mode: 'readwrite' });
                    if (permiso !== 'granted') {
                        showToast('Error', 'Permiso denegado para escribir en la carpeta seleccionada.', 'error');
                        return;
                    }

                } catch (e) {
                    showToast('Cancelado', 'Selecci√≥n de carpeta cancelada.', 'error');
                    return;
                }

                const toast = showToast('Procesando', `Descargando ${checkboxes.length} paquetes...`, 'success', 30000, true);
                actualizarToastProgreso(toast, 0);

                const documentosSeleccionados = Array.from(checkboxes).map(cb => {
                    const fila = cb.closest('tr');
                    const idMovDoc = cb.value;
                    const nFact = fila.querySelector('td:nth-child(2)').textContent.trim();
                    return { idMovDoc, nFact, fila};
                });

                const erroresRips = [];
                for (const doc of documentosSeleccionados) {
                    const ripsError = await ejecutarRips(doc.nFact);
                    if (ripsError) {
                        showToast('Error', ripsError, 'error');
                        erroresRips.push(doc.idMovDoc);
                        
                    }
                }

                const documentosValidos = documentosSeleccionados.filter(d => !erroresRips.includes(d.idMovDoc));
                if (documentosValidos.length === 0) {
                    showToast('Error', 'Ning√∫n documento pas√≥ validaci√≥n RIPS', 'error');
                    setTimeout(() => {
                        toast.classList.add('fadeOut');
                        setTimeout(() => toast.remove(), 300);
                    }, 1000);
                    return;
                }

                let paquetesExitosos = [];
                let paquetesFallidos = [];
                const incluirXml = document.getElementById('incluirXML').checked;

                for (let i = 0; i < documentosValidos.length; i++) {
                    const doc = documentosValidos[i];
                    const downloadError = await descargarZip(doc.idMovDoc, "json", incluirXml, doc.cuv, directoryHandle);
                    if (downloadError) {
                        showToast('Error', downloadError, 'error');
                        paquetesFallidos.push(doc.nFact);
                        setTimeout(() => {
                            toast.classList.add('fadeOut');
                            setTimeout(() => toast.remove(), 300);
                        }, 1000);
                        return;
                    }

                    paquetesExitosos.push(doc.nFact);
                    const progreso = Math.round(((i + 1) / documentosValidos.length) * 100);
                    actualizarToastProgreso(toast, progreso);
                }

                setTimeout(() => {
                    toast.classList.add('fadeOut');
                    setTimeout(() => toast.remove(), 300);
                }, 1000);

                if (paquetesExitosos.length === 1) {
                    showToast('√âxito', `El paquete con factura ${paquetesExitosos[0]} se ha descargado correctamente`, 'success');
                } else if (paquetesExitosos.length > 1) {
                    showToast(
                        '√âxito',
                        `${paquetesExitosos.length} de ${documentosSeleccionados.length} paquetes se han descargado correctamente`,
                        'success'
                    );
                }

            } finally {
                if (downloadButton) {
                    downloadButton.disabled = false;
                    downloadButton.innerHTML = originalHTML;
                    downloadButton.style.opacity = '1';
                    downloadButton.style.cursor = 'pointer';
                }

                if (botonBuscar) {
                    botonBuscar.disabled = false;
                    botonBuscar.style.opacity = '1';
                    botonBuscar.style.cursor = 'pointer';
                }

                if (botonEnviar) {
                    botonEnviar.disabled = false;
                    botonEnviar.style.opacity = '1';
                    botonEnviar.style.cursor = 'pointer';
                }
            }
        }

        async function DescargarPaquete(button) {
            const botonBuscar = document.getElementById("botonBuscar");
            const tipo = "json";
            const incluirXml = document.getElementById('incluirXML').checked;
            const row = button.closest('tr');
            const nfact = row.querySelector('td:nth-child(2)').textContent.trim();
            const id = button.getAttribute('data-id') || button.value;


            if (!nfact) {
                showToast('Error', `No se encontr√≥ Nfact para este documento`, 'error');
                return;
            }

            if (!id) {
                showToast('Error', `No se encontr√≥ ID para este documento`, 'error');
                return;
            }

            const originalHTML = button.innerHTML;
            button.disabled = true;
            button.innerHTML = 'Descargando...';
            button.style.opacity = '0.6';
            button.style.cursor = 'not-allowed';

            botonBuscar.disabled = true;
            botonBuscar.style.opacity = '0.6';
            botonBuscar.style.cursor = 'not-allowed';

            let directoryHandle;
            try {
                try {
                    directoryHandle = await window.showDirectoryPicker();

                    const permiso = await directoryHandle.requestPermission({ mode: 'readwrite' });
                    if (permiso !== 'granted') {
                        showToast('Error', 'Permiso denegado para escribir en la carpeta seleccionada.', 'error');
                        return;
                    }

                } catch (e) {
                    showToast('Cancelado', 'Selecci√≥n de carpeta cancelada.', 'error');
                    return;
                }

                const toast = showToast('Procesando', `Descargando paquete...`, 'success', 30000, true);
                actualizarToastProgreso(toast, 0);

                const errorRips = await ejecutarRips(nfact);
                if (errorRips) {
                    setTimeout(() => {
                        toast.classList.add('fadeOut');
                        setTimeout(() => toast.remove(), 300);
                    }, 1000);
                    showToast('Error', `Error al descargar ${nfact}, no hay JSON`, 'error');
                    
                    return;
                }

                actualizarToastProgreso(toast, 50);

                const downloadError = await descargarZip(id, tipo, incluirXml, cuv, directoryHandle);
                if (downloadError) {
                    setTimeout(() => {
                        toast.classList.add('fadeOut');
                        setTimeout(() => toast.remove(), 300);
                    }, 1000);
                    showToast('Error', downloadError, 'error');

                    return;
                }
                
                actualizarToastProgreso(toast, 100);
                setTimeout(() => {
                    toast.classList.add('fadeOut');
                    setTimeout(() => toast.remove(), 300);
                }, 1000);

                showToast('√âxito', `Factura ${nfact} descargada correctamente`, 'success');

            } finally {
                button.disabled = false;
                button.innerHTML = originalHTML;
                button.style.opacity = '1';
                button.style.cursor = 'pointer';

                botonBuscar.disabled = false;
                botonBuscar.style.opacity = '1';
                botonBuscar.style.cursor = 'pointer';
            }
        }



        async function ejecutarRips(nfact) {
            try {
                const response = await fetch(`/api/sql/ejecutarRips?Nfact=${encodeURIComponent(nfact)}`);
                const result = await response.text();

                if (!response.ok) {
                    return `Error al ejecutar RIPS para ${nfact}: ${result}`;
                }

                return null;
            } catch (error) {
                return `Error de red al ejecutar RIPS para ${nfact}: ${error.message}`;
            }
        }

        async function descargarZip(id, tipo, xml, directoryHandle) {
            const host = window.location.hostname;
            const url = `https://${host}:9876/certificados/generarzip/${id}/${tipo}/${xml}`; 

            try {
                const response = await fetch(url);

                if (!response.ok) {
                    const errorText = await response.text();
                    return `Error al descargar ZIP para ID ${id}: ${errorText}`;
                }

                const blob = await response.blob();
                let fileName = `certificado_${id}.zip`;

                const contentDisposition = response.headers.get('Content-Disposition');
                if (contentDisposition && contentDisposition.includes('filename=')) {
                    fileName = contentDisposition.split('filename=')[1].replace(/['"]/g, '').trim();
                }

                const fileHandle = await directoryHandle.getFileHandle(fileName, { create: true });
                const writable = await fileHandle.createWritable();
                await writable.write(blob);
                await writable.close();

                return false;
            } catch (error) {
                return `Error de red para ID ${id}: ${error.message}`;
            }
        }

        document.getElementById('idTercero').addEventListener('change', async function () {
            const idTerceroKey = this.value;
            const selectContratos = document.getElementById('noContrato');
            selectContratos.innerHTML = '<option value="">Seleccione un contrato</option>';

            if (idTerceroKey) {
                try {
                    const response = await fetch(`/filtros/contratos?idTerceroKey=${idTerceroKey}`);
                    const data = await response.json();

                    data.forEach(contrato => {
                        const option = document.createElement('option');
                        option.value = contrato.noContrato;
                        option.textContent = contrato.nomContrato;
                        selectContratos.appendChild(option);
                    });
                } catch (error) {
                    console.error("Error al cargar contratos:", error);
                }
            }
        });

        function showToast(title, message, type = 'success', duration = 6000, showProgress = false) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            toast.innerHTML = `
                <div class="toast-content">
                    <strong>${title}</strong>
                    <button class="close-toast" onclick="this.parentElement.parentElement.remove()">‚úñ</button>
                    <p>${message}</p>
                    ${showProgress ? `
                    <div class="toast-progress-container">
                        <div class="toast-progress-bar" style="width: 0%;"></div>
                    </div>` : ''}
                </div>
            `;

            container.appendChild(toast);

            if (!showProgress) {
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.classList.add('fadeOut');
                        setTimeout(() => {
                            container.removeChild(toast);
                        }, 300);
                    }
                }, duration);
            }


            return toast;
        }

        function actualizarToastProgreso(toast, porcentaje) {
            const progressBar = toast.querySelector('.toast-progress-bar');
            if (progressBar) {
                progressBar.style.width = `${porcentaje}%`;
            }
        }

                
        function toggleExpand(button) {
            const content = button.nextElementSibling;
            const isExpanded = content.classList.contains('expanded');

            if (isExpanded) {
                content.style.maxHeight = content.scrollHeight + 'px';
                requestAnimationFrame(() => {
                    content.style.maxHeight = '7em';
                });
                content.classList.remove('expanded');
                button.classList.remove('expanded');
            } else {
                content.style.maxHeight = content.scrollHeight + 'px';
                content.classList.add('expanded');
                button.classList.add('expanded');

                content.addEventListener('transitionend', function clearMax() {
                    if (content.classList.contains('expanded')) {
                        content.style.maxHeight = 'none';
                    }
                    content.removeEventListener('transitionend', clearMax);
                });
            }
        }

    </script>
</body>
</html>